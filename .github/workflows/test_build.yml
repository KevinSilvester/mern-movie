name: Test Build
on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize]
    
jobs:
  build:
    name: Build
    timeout-minutes: 15
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.2.20
          
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Test Build - Client App
        run: |
          bun install
          bun run -F moviedb-client-app lint:check
          bun run -F moviedb-client-app format:check
          bun run -F moviedb-client-app build

      - name: Test Build - Client Server
        run: |
          cargo fmt --package moviedb-client-server -- --check
          cargo clippy --package moviedb-client-server -- -D warnings
          cargo build --package moviedb-client-server

      - name: Test Build - API Server
        run: |
          cargo fmt --package moviedb-api-server -- --check
          cargo clippy --package moviedb-api-server -- -D warnings
          cargo build --package moviedb-api-server
          cargo test --package moviedb-api-server

